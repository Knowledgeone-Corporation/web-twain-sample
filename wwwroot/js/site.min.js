var initialScannerSettings=null;function ReInitializeScanningSection(){$(".finalize-section").addClass("section-disabled"),$(".scanning-section").removeClass("section-disabled"),$(".filetype-restriction").hide()}function RenderDesktopSelection(){K1WebTwain.GetDevices().then((function(e){for(var n=InitialiseDropDown($("#sel-scanner")),t=0;t<e.length;t++)n.append($("<option />").val(e[t].id).text(e[t].name));$("#sel-scanner").unbind().change(DesktopScannerSelect),SetDefaultScanSetting(),$("#device-group").show(),BindAcquire()})).catch((function(e){console.error(e)}))}function RenderSelection(){K1WebTwain.GetDevices().then((function(e){BindScannerSelection(e),SetDefaultScanSetting(),$("#device-group").show(),BindAcquire()})).catch((function(e){console.error(e)}))}function BindAcquire(){$("#btn-acquire").unbind().click((function(e){$("#errorMessageDiv").hide(),K1WebTwain.StartScan({deviceId:$("#sel-scanner").val(),resolutionId:$("#sel-dpi").val(),pixelTypeId:$("#sel-color").val(),pageSizeId:$("#sel-page-size").val(),documentSourceId:$("#sel-document-source").val(),documentSourceName:$("#sel-document-source option:selected").text(),duplexId:$("#sel-duplex").val()}).then((function(e){!e.success||e.pageCount<=0?($("#errorMessageOutput").text("Error while scanning."),$("#errorMessageDiv").show(),InitialiseInterfaceOption()):($("#btn-acquire").attr("disabled","disabled"),$(".finalize-section").removeClass("section-disabled"),$(".scanning-section").addClass("section-disabled"))})).catch((function(e){if(e){if(e.responseJSON)try{$("#errorMessageOutput").text(JSON.stringify(e.responseJSON,null,4))}catch(n){e.responseText&&$("#errorMessageOutput").text(e.responseText)}e.responseText&&$("#errorMessageOutput").text(e.responseText),$("#errorMessageDiv").show(),InitialiseInterfaceOption()}}))})),$("#btn-attach").unbind().click((function(e){K1WebTwain.ValidatePageSize({ocrType:$("#sel-ocr-type").val(),fileType:$("#sel-output").val(),saveToType:K1WebTwain.Options.SaveToType.Upload,generateDocument:function(){GenerateDocument(K1WebTwain.Options.SaveToType.Upload)}})})),$("#btn-save-locally").unbind().click((function(e){K1WebTwain.ValidatePageSize({ocrType:$("#sel-ocr-type").val(),fileType:$("#sel-output").val(),saveToType:K1WebTwain.Options.SaveToType.Local,generateDocument:function(){GenerateDocument(K1WebTwain.Options.SaveToType.Local)}})})),$("#btn-cancel-finalization").unbind().click((function(e){this.blur(),K1WebTwain.ClearAllScannedPages().then((function(){$("#btn-acquire").removeAttr("disabled"),ReInitializeScanningSection()})).catch((function(e){console.error(e)}))}))}function GenerateDocument(e){$("#errorMessageDiv").hide(),K1WebTwain.GenerateDocument({filetype:$("#sel-output").val(),ocrType:$("#sel-ocr-type").val(),saveToType:e,filename:$("#sel-output-name").val()}).then((function(e){$(".filename").val(e.filename),$(".filesize").text(e.sizeDisplay),$(".filesize").show(),$(".fileview").show();var n=e.uploadResponse;e.saveToType===K1WebTwain.Options.SaveToType.Local?($("#viewBtn").text("Download"),$(".upload-response-header").text("File Info:"),n={filename:e.filename,fileSize:`${e.fileLength} (${e.sizeDisplay})`,fileExtension:e.extension}):($("#viewBtn").text("View"),$(".upload-response-header").text("Response from file upload route:")),$("#uploadResponseOutput").text(JSON.stringify(n,null,4)),$("#uploadResponseDiv").show(),InitialiseInterfaceOption()})).catch((function(e){if(e){if(e.statusText&&"timeout"===e.statusText&&$("#errorMessageOutput").text("Timeout error while processing/uploading scanned documents."),e.responseJSON)try{$("#errorMessageOutput").text(JSON.stringify(e.responseJSON,null,4))}catch(n){e.responseText&&$("#errorMessageOutput").text(e.responseText)}e.responseText&&$("#errorMessageOutput").text(e.responseText),$("#errorMessageDiv").show(),InitialiseInterfaceOption()}}))}function BindScannerSelection(e){for(var n=InitialiseDropDown($("#sel-scanner")),t=0;t<e.length;t++)n.append($("<option />").val(e[t].id).text(e[t].name));$("#sel-scanner").unbind().change(ScannerSelect)}function DesktopScannerSelect(){SaveDefaultScanSettings();var e=$("#sel-scanner").val();e&&-1!=e?$("#btn-acquire").removeAttr("disabled"):$("#btn-acquire").attr("disabled","disabled")}function ScannerSelect(){SaveDefaultScanSettings();var e=function(e,n){if(InitialiseDropDown(e),jQuery.isEmptyObject(n))e.parent().hide();else{for(var t in n)e.append($("<option />").val(t).text(n[t]));e.parent().show()}},n=$("#sel-scanner").val();n&&K1WebTwain.Device(n).then((function(n){e($("#sel-document-source"),{}),e($("#sel-color"),{}),e($("#sel-dpi"),{}),e($("#sel-page-size"),{}),e($("#sel-duplex"),{}),n?($("#btn-acquire").removeAttr("disabled"),BindDocumentSource(n.documentSourceIds),SetDefaultSelectSetting($("#sel-document-source"),initialScannerSettings?.ScannerDetails?.DocumentSource)):$("#btn-acquire").attr("disabled","disabled")})).catch((function(e){console.error(e);var n=JSON.stringify(e.responseJSON,null,4);$("#errorMessageOutput").text(n),$("#errorMessageDiv").show()}))}function BindDocumentSource(e){var n=InitialiseDropDown($("#sel-document-source"));for(var t in e)n.append($("<option />").val(e[t].id).text(e[t].name));n.parent().show(),$("#sel-document-source").unbind(),$("#sel-document-source").change(DocumentSourceSelect),DocumentSourceSelect()}function DocumentSourceSelect(){var e=function(e,n){if(InitialiseDropDown(e),jQuery.isEmptyObject(n))e.parent().hide();else{for(var t in n)e.append($("<option />").val(t).text(n[t]));e.parent().show()}},n=$("#sel-document-source").val();if(n){var t=$("#sel-scanner").val(),i=K1WebTwain.FetchedDevice(t);if(i){var a=i.documentSourceIds[n];if(e($("#sel-color"),a.pixelTypeIds),e($("#sel-dpi"),a.resolutionIds),e($("#sel-page-size"),a.pageSizeIds),e($("#sel-duplex"),a.duplexIds),$(".sel-scanner-settings").unbind().change(SaveDefaultScanSettings),$(".sel-scanner-settings").change(),initialScannerSettings?.ScannerDetails){const e=initialScannerSettings.ScannerDetails;SetDefaultSelectSetting($("#sel-dpi"),e.Resolution),SetDefaultSelectSetting($("#sel-color"),e.Color),SetDefaultSelectSetting($("#sel-page-size"),e.PageSize),SetDefaultSelectSetting($("#sel-duplex"),e.Duplex)}SaveDefaultScanSettings()}}}function SetDefaultSelectSetting(e,n){n&&e.find("option[value='"+n+"']").length>0&&e.val(n).trigger("change")}function InitialiseInterfaceOption(){var e=$("#interface-option-dropdown");e.empty(),e.append("<option disabled selected>Please select...</option>"),e.append("<option value='0'>Hidden : Not using Webtwain or Native UI</option>"),e.append("<option value='1'>Visible : Uses Webtwain and Native UI</option>"),e.append("<option value='2'>Web : only uses Webtwain UI</option>"),e.append("<option value='3'>Desktop : only uses Native scanner UI</option>"),$("#btn-acquire").hide(),$("#scanbtn").hide(),$("#k1interface-intialization").addClass("hide"),$("#k1interface-hidden").addClass("hide")}function InitialiseDropDown(e){return e.empty(),e.selectedIndex=0,e}function K1ScanServiceComplete(e){$(".filename").val(e.filename),$(".filesize").text(e.sizeDisplay),$(".filesize").show(),$(".fileview").show(),$("#saveBtn").removeAttr("disabled");var n=e.uploadResponse;e.saveToType===K1WebTwain.Options.SaveToType.Local?($("#viewBtn").text("Download"),$(".upload-response-header").text("File Info:"),n={filename:e.filename,fileSize:`${e.fileLength} (${e.sizeDisplay})`,fileExtension:e.extension}):($("#viewBtn").text("View"),$(".upload-response-header").text("Response from file upload route:")),$("#uploadResponseOutput").text(JSON.stringify(n,null,4)),$("#uploadResponseDiv").show()}function ShowWait(e,n){e?$(".k1ss-msg").text(e):$(".k1ss-msg").text("Loading, please wait..."),n||(n=!1),1==n?$(".k1ss-msgbox .k1ss-close").show():$(".k1ss-msgbox .k1ss-close").hide(),$(".k1ss-wait-div").show()}function HideWait(){$(".k1ss-wait-div").hide()}function SaveDefaultScanSettings(){var e=GetDefaultScanSettings(),n=e?.ScannerDetails,t={ScanSource:$("#sel-scanner").val()??n?.ScanSource,DocumentSource:$("#sel-document-source").val()??n?.DocumentSource,Resolution:$("#sel-dpi").val()??n?.Resolution,Color:$("#sel-color").val()??n?.Color,PageSize:$("#sel-page-size").val()??n?.PageSize,Duplex:$("#sel-duplex").val()??n?.Duplex},i=$("#sel-output").val(),a=$("#sel-ocr-type").val(),o=IsPDF(i)&&a!=K1WebTwain.Options.OcrType.None;e?(e.ScanType=i,e.UseOCR=o,e.OCRType=a,e.ScannerDetails=t):e={ScanType:i,UseOCR:o,OCRType:a,ScannerDetails:t};!function(e,n,t){var i="";if(t){var a=new Date;a.setTime(a.getTime()+24*t*60*60*1e3),i="; expires="+a.toUTCString()}document.cookie=e+"="+(n||"")+i+"; path=/"}("DefaultScanSettings",JSON.stringify(e),365)}function GetDefaultScanSettings(){var e=function(e){for(var n=e+"=",t=document.cookie.split(";"),i=0;i<t.length;i++){for(var a=t[i];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(n))return a.substring(n.length,a.length)}return null}("DefaultScanSettings");if(null!=e)try{return JSON.parse(e)}catch(e){return null}return null}function SetDefaultScanSetting(){initialScannerSettings=GetDefaultScanSettings(),$("#sel-scanner").val(initialScannerSettings?.ScannerDetails?initialScannerSettings.ScannerDetails.ScanSource:"-1").trigger("change");var e=function(e,n){for(var t in InitialiseDropDown(e),n)e.append($("<option />").val(n[t]).text(t))};e($("#sel-ocr-type"),K1WebTwain.Options.OcrType),e($("#sel-output"),K1WebTwain.Options.OutputFiletype),$("#sel-output").unbind().change((function(){IsPDF($(this).val())?$(".pdf-section").show():$(".pdf-section").hide(),SaveDefaultScanSettings()})),$("#sel-ocr-type").unbind().change(SaveDefaultScanSettings),initialScannerSettings&&(initialScannerSettings.ScanType&&$("#sel-output").val(initialScannerSettings.ScanType).trigger("change"),initialScannerSettings.OCRType&&$("#sel-ocr-type").val(initialScannerSettings.UseOCR?initialScannerSettings.OCRType:K1WebTwain.Options.OcrType.None).trigger("change"))}function IsPDF(e){return e===K1WebTwain.Options.OutputFiletype.PDF||e===K1WebTwain.Options.OutputFiletype["PDF/A"]}$((function(){InitialiseInterfaceOption(),$("#interface-option-dropdown").change((function(e){$("#errorMessageDiv").hide(),$(".twain-feature-group").hide();var n=$(e.target),t=parseInt(n.val()),i={onComplete:K1ScanServiceComplete,viewButton:$(".k1ViewBtn"),fileUploadURL:document.location.origin+"/Home/UploadFile",fileUploadHeaders:[{key:"X-Access-Token",value:"Test"}],clientID:$("#ClientID").val(),setupFile:document.location.origin+"/Home/DownloadSetup",licenseFile:document.location.origin+"/Home/K1Licence",interfacePath:"",scannerInterface:t,scanButton:$("#scanbtn"),barcodeRecognitionOption:{barcodeFormats:[],barcodeOrientations:[]}};ShowWait("Preparing...",!1),K1WebTwain.Configure(i).then((function(e){$("#btn-acquire").show(),$("#scanbtn").show(),$(".alert").hide(),$("#k1interface-intialization").addClass("hide"),$("#k1interface-hidden").addClass("hide"),ReInitializeScanningSection(),K1WebTwain.ResetService().then((function(){$("#k1interface-intialization").removeClass("hide"),HideWait()}))})).catch((function(e){HideWait(),$("#k1interface-intialization").addClass("hide"),$("#k1interface-hidden").addClass("hide"),console.error(e),$("#errorMessageOutput").text(e),$("#errorMessageDiv").show(),K1WebTwain.ResetService()})),$("#scanbtn").click((function(e){switch(t){case K1WebTwain.Options.ScannerInterface.Visible:case K1WebTwain.Options.ScannerInterface.Web:$("#k1interface-hidden").addClass("hide"),InitialiseInterfaceOption();break;case K1WebTwain.Options.ScannerInterface.Hidden:RenderSelection(),$("#k1interface-intialization").addClass("hide"),$("#k1interface-hidden").removeClass("hide"),$("#sel-output-name").val("ScanFile"+Math.floor(1e4*Math.random()+1e5));break;case K1WebTwain.Options.ScannerInterface.Desktop:RenderDesktopSelection(),$("#k1interface-intialization").addClass("hide"),$("#k1interface-hidden").removeClass("hide"),$("#sel-output-name").val("ScanFile"+Math.floor(1e4*Math.random()+1e5))}}))}));var e=$("#SelectedInterface").val();e.length>0&&$("#interface-option-dropdown").val(e).change()}));